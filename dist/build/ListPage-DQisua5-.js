import{a as b,eJ as k,y as N,x as B,r as P,j as e,cy as f,cN as Q,cO as _,f as T,L as H,a1 as q,T as g,K as G,O,l as J,eK as z,u as $,bB as K,N as Y,Q as V,R as W,a$ as w,P as L,B as X,E as A,cQ as j,bU as l,I as Z,aj as ee,cR as E}from"./strapi-Ct9MU9_y.js";import{a as se,g as v,u as te,b as ae}from"./getActionTypesDefaultMessages-BMqAhjxA.js";import{g as ie}from"./users-DLc-PG84.js";const U=()=>{const{formatDate:s}=b();return n=>{const a=k(n),o=s(a,{dateStyle:"long"}),t=s(a,{timeStyle:"medium",hourCycle:"h24"});return`${o}, ${t}`}},ne=({handleClose:s,logId:i})=>{const{toggleNotification:n}=N(),{_unstableFormatAPIError:a}=B(),{data:o,error:t,isLoading:d}=se(i);P.useEffect(()=>{t&&(n({type:"danger",message:a(t)}),s())},[t,a,s,n]);const u=U(),c=o&&"date"in o?u(o.date):"";return e.jsx(f.Root,{defaultOpen:!0,onOpenChange:s,children:e.jsxs(f.Content,{children:[e.jsx(f.Header,{children:e.jsx(Q,{label:c,id:"title",children:e.jsx(_,{isCurrent:!0,children:c})})}),e.jsx(f.Body,{children:e.jsx(oe,{isLoading:d,data:o,formattedDate:c})})]})})},oe=({isLoading:s,data:i,formattedDate:n})=>{const{formatMessage:a}=b();if(s)return e.jsx(T,{padding:7,justifyContent:"center",alignItems:"center",children:e.jsx(H,{children:"Loading content..."})});const{action:o,user:t,payload:d}=i;return e.jsxs(e.Fragment,{children:[e.jsx(q,{marginBottom:3,children:e.jsx(g,{variant:"delta",id:"title",children:a({id:"Settings.permissions.auditLogs.details",defaultMessage:"Log Details"})})}),e.jsxs(G.Root,{gap:4,gridCols:2,paddingTop:4,paddingBottom:4,paddingLeft:6,paddingRight:6,marginBottom:4,background:"neutral100",hasRadius:!0,children:[e.jsx(h,{actionLabel:a({id:"Settings.permissions.auditLogs.action",defaultMessage:"Action"}),actionName:a({id:`Settings.permissions.auditLogs.${o}`,defaultMessage:v(o)},{model:d?.model})}),e.jsx(h,{actionLabel:a({id:"Settings.permissions.auditLogs.date",defaultMessage:"Date"}),actionName:n}),e.jsx(h,{actionLabel:a({id:"Settings.permissions.auditLogs.user",defaultMessage:"User"}),actionName:t?.displayName||"-"}),e.jsx(h,{actionLabel:a({id:"Settings.permissions.auditLogs.userId",defaultMessage:"User ID"}),actionName:t?.id.toString()||"-"})]}),e.jsxs(O.Root,{children:[e.jsx(O.Label,{children:a({id:"Settings.permissions.auditLogs.payload",defaultMessage:"Payload"})}),e.jsx(re,{value:JSON.stringify(d,null,2),disabled:!0})]})]})},re=J(z)`
  max-width: 100%;
  overflow: scroll;
`,h=({actionLabel:s,actionName:i})=>e.jsxs(T,{direction:"column",alignItems:"baseline",gap:1,children:[e.jsx(g,{textColor:"neutral600",variant:"sigma",children:s}),e.jsx(g,{textColor:"neutral600",children:i})]}),de=({canReadAuditLogs:s,canReadUsers:i})=>{const{toggleNotification:n}=N(),{_unstableFormatAPIError:a}=B(),[{query:o}]=$(),{data:t,error:d,isError:u,isLoading:c}=K({},{skip:!i,refetchOnMountOrArgChange:!0});P.useEffect(()=>{d&&n({type:"danger",message:a(d)})},[d,n,a]);const{data:y,isLoading:S,isError:C,error:p}=te(o,{refetchOnMountOrArgChange:!0,skip:!s});return P.useEffect(()=>{p&&n({type:"danger",message:a(p)})},[p,n,a]),{auditLogs:y,users:t?.users??[],isLoading:c||S,hasError:C||u}},D=s=>{const{formatMessage:i}=b(),n=Y(s.name),a=i({id:"Settings.permissions.auditLogs.filter.aria-label",defaultMessage:"Search and select an option to filter"}),o=t=>{n.onChange(s.name,t)};return e.jsx(V,{"aria-label":a,value:n.value,onChange:o,children:s.options?.map(t=>{const d=typeof t=="string"?t:t.value,u=typeof t=="string"?t:t.label;return e.jsx(W,{value:d,children:u},d)})})},le=({formatMessage:s,users:i,canReadUsers:n})=>{const a=[{label:s({id:"components.FilterOptions.FILTER_TYPES.$eq",defaultMessage:"is"}),value:"$eq"},{label:s({id:"components.FilterOptions.FILTER_TYPES.$ne",defaultMessage:"is not"}),value:"$ne"}],o=[{input:D,label:s({id:"Settings.permissions.auditLogs.action",defaultMessage:"Action"}),name:"action",operators:a,options:Object.keys(ae).map(t=>({label:s({id:`Settings.permissions.auditLogs.${t}`,defaultMessage:v(t)},{model:void 0}),value:t})),type:"enumeration"},{label:s({id:"Settings.permissions.auditLogs.date",defaultMessage:"Date"}),name:"date",type:"datetime"}];return n&&i?[...o,{input:D,label:s({id:"Settings.permissions.auditLogs.user",defaultMessage:"User"}),mainField:{name:"id",type:"integer"},name:"user",operators:a,options:i.map(t=>({label:ie(t),value:t.id.toString()})),type:"relation"}]:o},ue=()=>{const{formatMessage:s}=b(),i=w(r=>r.admin_app.permissions.settings),{allowedActions:{canRead:n,canReadUsers:a},isLoading:o}=X({...i?.auditLogs,readUsers:i?.users.read||[]}),[{query:t},d]=$(),{auditLogs:u,users:c,isLoading:y,hasError:S}=de({canReadAuditLogs:n,canReadUsers:a}),C=U(),p=le({formatMessage:s,users:c,canReadUsers:a}),M=[{name:"action",label:s({id:"Settings.permissions.auditLogs.action",defaultMessage:"Action"}),sortable:!0},{name:"date",label:s({id:"Settings.permissions.auditLogs.date",defaultMessage:"Date"}),sortable:!0},{name:"user",label:s({id:"Settings.permissions.auditLogs.user",defaultMessage:"User"}),sortable:!1,cellFormatter:({user:r})=>r?r.displayName:""}];if(S)return e.jsx(L.Error,{});const R=y||o,{results:F=[]}=u??{};return e.jsxs(L.Main,{"aria-busy":R,children:[e.jsx(L.Title,{children:s({id:"Settings.PageTitle",defaultMessage:"Settings - {name}"},{name:s({id:"global.auditLogs",defaultMessage:"Audit Logs"})})}),e.jsx(A.Header,{title:s({id:"global.auditLogs",defaultMessage:"Audit Logs"}),subtitle:s({id:"Settings.permissions.auditLogs.listview.header.subtitle",defaultMessage:"Logs of all the activities that happened in your environment"})}),e.jsx(A.Action,{startActions:e.jsxs(j.Root,{options:p,children:[e.jsx(j.Trigger,{}),e.jsx(j.Popover,{zIndex:499}),e.jsx(j.List,{})]})}),e.jsxs(A.Content,{children:[e.jsx(l.Root,{rows:F,headers:M,isLoading:R,children:e.jsxs(l.Content,{children:[e.jsx(l.Head,{children:M.map(r=>e.jsx(l.HeaderCell,{...r},r.name))}),e.jsx(l.Empty,{}),e.jsx(l.Loading,{}),e.jsx(l.Body,{children:F.map(r=>e.jsxs(l.Row,{onClick:()=>d({id:r.id}),children:[M.map(x=>{const{name:m,cellFormatter:I}=x;switch(m){case"action":return e.jsx(l.Cell,{children:e.jsx(g,{textColor:"neutral800",children:s({id:`Settings.permissions.auditLogs.${r.action}`,defaultMessage:v(r.action)},{model:r.payload?.model??""})})},m);case"date":return e.jsx(l.Cell,{children:e.jsx(g,{textColor:"neutral800",children:C(r.date)})},m);case"user":return e.jsx(l.Cell,{children:e.jsx(g,{textColor:"neutral800",children:I?I(r,x):"-"})},m);default:return e.jsx(l.Cell,{children:e.jsx(g,{textColor:"neutral800",children:r[m]||"-"})},m)}}),e.jsx(l.Cell,{onClick:x=>x.stopPropagation(),children:e.jsx(T,{justifyContent:"end",children:e.jsx(Z,{onClick:()=>d({id:r.id}),withTooltip:!1,label:s({id:"app.component.table.view",defaultMessage:"{target} details"},{target:`${r.action} action`}),variant:"ghost",children:e.jsx(ee,{})})})})]},r.id))})]})}),e.jsxs(E.Root,{...u?.pagination,children:[e.jsx(E.PageSize,{}),e.jsx(E.Links,{})]})]}),t?.id&&e.jsx(ne,{handleClose:()=>d({id:""},"remove"),logId:t.id.toString()})]})},pe=()=>{const s=w(i=>i.admin_app.permissions.settings?.auditLogs?.main);return e.jsx(L.Protect,{permissions:s,children:e.jsx(ue,{})})};export{ue as ListPage,pe as ProtectedListPage};
